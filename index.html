<!DOCTYPE html>
<html lang="es" data-bs-theme="dark">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DynQRs-by_SebACanRN</title>
  <!--
    Incorporamos la libreria de BOOTSTRAP
  -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <!--
    Inicia style personalizado propio.
  -->
  <style>
   .qr-container {
    width: 100%;
    height: 100%;
    border-radius: 9px;
    position: relative;
   }
   .qr-border {
    width: 450px;
    height: 450px;
    background-color: black;
    padding: 9px;
    border-radius: 9px;
    position: relative;
   }
   .qr-eye0 {
    width: 63px;
    height: 63px;
    background-color: black;
    border-radius: 9px;
   }
   .qr-eye-bg0 {
    width: 81px;
    height: 81px;
    background-color: white;
    border-radius: 0px;
    display: flex;
    justify-content: center;
    align-items: center;
    position: absolute;
    z-index: 10000;
   }

   .qr-eye1 {
    width: 36px;
    height: 36px;
    background-color: black;
    border-radius: 9px;
   }
   
   .qr-eye-bg1 {
    width: 54px;
    height: 54px;
    background-color: white;
    border-radius: 0px;
    display: flex;
    justify-content: center;
    align-items: center;
    position: absolute;
    z-index: 10000;
   }

   .top-left {
    top: 9px;
    left: 9px;
   }
   .top-right {
    top: 9px;
    right: 9px;
   }
   .bottom-left {
    bottom: 9px;
    left: 9px;
   }
   .bottom-right {
    bottom: 81px;
    right: 81px;
   }

   .qr-block {
    width: 18px;
    height: 18px;
    background-color: black;
    position: absolute;
   }
  </style>
</head>
<body class="container">

  <div class="d-flex justify-content-center align-items-center" style="min-height: 100vh;">
    <div class="container ">
      <div class="row">
        <div class="col d-flex justify-content-center align-items-center">
          <span class="fs-2">Bienvenido</span>
        </div>
      </div>
      <div class="row">
        <div class="col d-flex justify-content-center align-items-center">
          <div class="qr-border d-flex justify-content-center align-items-center">
            <div class="qr-eye-bg0 top-left">
              <div class="qr-eye0"></div>
            </div>
            <div class="qr-eye-bg0 top-right">
              <div class="qr-eye0"></div>
            </div>
            <div class="qr-eye-bg0 bottom-left">
              <div class="qr-eye0"></div>
            </div>
            <div class="qr-eye-bg1 bottom-right">
              <div class="qr-eye1"></div>
            </div>
            <div class="qr-container"></div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col d-flex justify-content-center align-items-center">
          <span class="fs-4" id="status"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Agregando Bootstrap -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

  <script>
    const qrContainer = document.querySelector('.qr-container');
    const totalBlocks = 24 * 24;
    const blocks = [];

    // Crea los bloques y los añade al contenedor y al array 'blocks'
    for (let i = 0; i < 24; i++) {
      for (let j = 0; j < 24; j++) {
          const block = document.createElement('div');
          block.classList.add('qr-block');
          block.style.left = `${j * 18}px`;
          block.style.top = `${i * 18}px`;
          qrContainer.appendChild(block);
          blocks.push(block);
      }
    }

    // Pinta inicialmente el 60% de los bloques de negro y el 40% de blanco
    const blackBlocksCount = Math.floor(totalBlocks * 0.6);
    const shuffledBlocks = [...blocks].sort(() => 0.5 - Math.random());

    for (let i = 0; i < totalBlocks; i++) {
      if (i < blackBlocksCount) {
          shuffledBlocks[i].style.backgroundColor = 'black';
      } else {
          shuffledBlocks[i].style.backgroundColor = 'white';
      }
    }

    // Filtra los bloques que inicialmente son negros
    let blackBlocks = blocks.filter(block => block.style.backgroundColor === 'black');
    let animationInterval;

    // Función para pintar 9 bloques negros de blanco al azar
    function toggleRandomBlocks() {
      var textStatus = document.getElementById("status");
      textStatus.innerHTML = "Leyendo Código QR";

      if (blackBlocks.length === 0) {
        clearInterval(animationInterval);
        return;
      }

      for (let i = 0; i < 9 && blackBlocks.length > 0; i++) {
        const randomIndex = Math.floor(Math.random() * blackBlocks.length);
        blackBlocks[randomIndex].style.backgroundColor = 'white';
            
        // Elimina el bloque del array para que no se vuelva a seleccionar
        blackBlocks.splice(randomIndex, 1);
      }
    }

    // Inicia la animación
    animationInterval = setInterval(toggleRandomBlocks, 153);
    
    // Lectura de la aplicación web en Google Apps Script.
    const scriptUrl = 'https://script.google.com/macros/s/AKfycbw0BlRIJDriZhg6jrdawO5KDYMMsAZsAjHJbxBnEIOj8GAxWvYPjWiCRL2RKJ1UyQLk/exec';
    function getParameterByName(name, url = window.location.href) {
      name = name.replace(/[\[\]]/g, '\\$&');
      const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
      const results = regex.exec(url);
      if (!results) return null;
      if (!results[2]) return '';
      return decodeURIComponent(results[2].replace(/\+/g, ' '));
    }
    const keyParam = getParameterByName('K');
    if (keyParam) {
      const finalUrl = `${scriptUrl}?K=${keyParam}`;
      fetch(finalUrl)
        .then(response => {
          // Si el script de Google App Script responde correctamente
          if (response.ok) {
            textStatus.innerHTML = "Acceso concedido.";
            textStatus.style.color = "green";
            return response.text();
          }
          throw new Error('Error en la respuesta del servidor.');
        })
        .then(url => {
          // Redirigir a la URL recibida
          if (url && url.startsWith('http')) {
            document.location.replace(url);
          } else {
            // En caso de error, mostrar un mensaje.
            textStatus.innerHTML = 'Error: URL de destino no válida.';
            textStatus.style.color = "red";
          }
        })
        .catch(error => {
          textStatus.innerHTML = `<h1>Error: ${error.message}</h1>`;
          textStatus.style.color = "red";
        });
    } else {
      textStatus.innerHTML = 'Error: No se encontró el parámetro K en la URL.';
      textStatus.style.color = "red";
    }
  </script>
</body>
</html>
